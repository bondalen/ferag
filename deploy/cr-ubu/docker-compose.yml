version: '3.8'

# cr-ubu: 1 контейнер (FastAPI + Redis через supervisord)
# Nginx в системе (не в Docker) — конфиг: nginx-location-ferag.conf
# Порты: FastAPI 47821, Redis 47379

services:
  ferag:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: ferag
    restart: unless-stopped
    ports:
      - "127.0.0.1:47821:47821"  # FastAPI → Nginx (только localhost)
      - "10.7.0.1:47379:47379"   # Redis → Celery worker на nb-win (WireGuard)
    volumes:
      - ferag-data:/data          # Redis persistence (/data внутри контейнера)
      - ./uploads:/app/uploads    # Временные загруженные файлы
    environment:
      - DATABASE_URL=postgresql://ferag:${DB_PASSWORD}@10.7.0.3:45432/ferag_app
      - REDIS_URL=redis://127.0.0.1:47379/0
      - JWT_SECRET=${JWT_SECRET}
      - FUSEKI_URL=http://10.7.0.3:43030
      - ALLOWED_ORIGINS=https://ontoline.ru

volumes:
  ferag-data:
