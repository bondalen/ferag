# Проектная документация: graph-rag-lab

## 1. Назначение и философская основа проекта

**graph-rag-lab** — лабораторный проект по построению локальной системы графового RAG (Retrieval-Augmented Generation) на основе текста. Цель: превращать текстовые корпуса в структурированный граф знаний (онтологию) и получать ответы на сложные вопросы, опираясь на связи между сущностями.

### 1.1. Диалектический подход: Тезис — Антитезис — Синтез

Проект основан на классической диалектической методологии познания, применённой к построению графа знаний:

#### **Тезис** (Новое знание)
- **Субъект**: Локальная LLM (Ollama + Llama 3.2/3.3, DeepSeek-R1)
- **Объект**: Новый корпус текста
- **Действие**: Извлечение сущностей и связей, формирование триплетов (субъект-предикат-объект)
- **Результат**: Неорганизованный массив триплетов — сырые данные без структуры
- **Характер**: Хаос, потенциальное знание, требующее упорядочивания

#### **Антитезис** (Существующее знание)
- **Субъект**: Ранее синтезированная онтология
- **Природа**: Структурированная система классов сущностей и типов связей
- **Действие**: Предоставление формальной схемы для классификации триплетов
- **Характер**: Порядок, организованное накопленное знание

#### **Синтез** (Разрешение противоречия)

Когда неорганизованные триплеты (Тезис) сталкиваются с существующей онтологией (Антитезис), происходит процесс синтеза нового знания. Массив триплетов разделяется на две части:

**А) "Горизонтальный/Ламинарный/Эволюционный" рост:**
- Триплеты, которые "ложатся" в существующую структуру онтологии
- Дополняют имеющиеся классы и отношения новыми экземплярами
- Онтология количественно растёт, но структурно остаётся стабильной
- Пример: новый `Person → worksFor → Organization`, где типы уже определены

**Б) "Вертикальный/Турбулентный/Революционный" рост:**
- Триплеты, которые не вписываются в существующую схему
- Требуют расширения онтологии: новые классы, новые типы отношений, модификация иерархии
- Онтология претерпевает структурные изменения
- Пример: обнаружение нового типа связи между сущностями, отсутствующего в схеме

**Критерий завершения синтеза:**
Онтология включает весь массив триплетов (или его часть, определённую пользователем). Противоречие между хаосом новых данных и порядком существующей структуры разрешено.

**Важно:** Новая обогащённая онтология сама становится **Антитезисом** для следующего корпуса текста (нового Тезиса) → циклический процесс познания.

### 1.2. Эксплуатация vs. Синтез

**Эксплуатация** — это получение ответов на вопросы пользователя по уже синтезированной онтологии. Это использование готового знания, а не создание нового. Эксплуатация следует после синтеза и не является его частью.

---

## 2. Цели и результаты

| Цель | Описание |
|------|----------|
| Локальный запуск LLM | Запуск больших языковых моделей на своём ПК без облачных API. |
| Графовый RAG | Построение графа знаний из текста и ответы на сложные/глобальные вопросы. |
| Онтология как ядро | Создание и развитие онтологии, которая структурирует извлечённые из текста триплеты. |
| Диалектический цикл | Реализация циклического процесса познания: новые данные → синтез → обогащённая онтология. |
| Визуализация | Инструменты для визуализации графа знаний и онтологий (Neo4j, Protégé, QGIS). |
| Воспроизводимая среда | Windows + WSL2 + Cursor + Ollama + Docker для разработки и экспериментов. |

---

## 3. Целевая платформа (железо)

### 3.1. Текущая конфигурация

| Параметр | Значение |
|----------|----------|
| Устройство | Мини-ПК GMKtec NucBox K8 Plus (Barebone) |
| Процессор | AMD Ryzen 7 8845HS (Zen 4, NPU Ryzen AI, 8 ядер) |
| ОЗУ | 64 ГБ |
| iGPU | AMD Radeon 780M (выделено 8 ГБ из ОЗУ в BIOS) |
| Хранилище (основной) | Samsung 990 Pro 2 ТБ (C: 300 ГБ Windows, D: ~1.7 ТБ данные) |
| Хранилище (планируется) | Второй SSD M.2 NVMe 1-2 ТБ для Fedora 43 |
| Порты расширения | OCuLink (для будущего подключения eGPU) |
| Сеть | AMD RZ616 Wi-Fi 6E 160MHz (MediaTek MT7922), Realtek 2.5G Ethernet ×2 |

### 3.2. Ожидаемые возможности (на 2026)

**Текущая конфигурация (iGPU):**
- LLM: модели 7B–14B комфортно; 30B-70B с квантованием (Q4_K_M, Q5_K_M)
- LightRAG: 50–100 тыс. страниц (200–500 МБ текста); индексация 100 стр. ~20–30 мин
- MS GraphRAG: до 5–10 тыс. страниц; индексация существенно медленнее, но глубже по аналитике

**С eGPU через OCuLink (перспектива):**
- LLM: модели до 120B с высоким квантованием (Q6, Q8)
- Скорость индексации: ускорение в 3-5 раз
- Параллельная работа: 2-3 модели одновременно
- Видеокарты: RTX 4070 Ti / 4080 (16 ГБ VRAM)

---

## 4. Целевой программный стек

### 4.1. Основные компоненты

| Компонент | Назначение |
|-----------|------------|
| **Windows 11 Pro** | Хост-ОС, визуализация, GUI-инструменты, Ollama, Cursor, Docker Desktop. |
| **WSL2 (Ubuntu)** | Разработка (проект `graph-rag-lab`), Python, Docker-контейнеры, вычисления. |
| **Fedora 43** (планируется) | Нативная Linux-среда для тяжёлых вычислений, индексации больших корпусов, моделей 70B+. |
| **Cursor** | IDE (форк VS Code), интеграция с WSL, связь с Ollama (http://localhost:11434) для автодополнения. Cursor Agent CLI для помощи в терминале. |
| **Ollama** | Локальный запуск LLM (Llama 3.2, Llama 3.3 70B, DeepSeek-R1) для извлечения сущностей и чата. |
| **Docker Desktop** | Запуск графовых БД (Neo4j, FalkorDB) и сервисов RAG в контейнерах. |
| **LightRAG / MS GraphRAG** | Фреймворки для построения графа знаний с привязкой к онтологии. |

### 4.2. Инструменты визуализации и работы с онтологиями

| Инструмент | Назначение | Платформа |
|------------|------------|-----------|
| **Neo4j Browser** | Визуализация графа знаний, выполнение Cypher-запросов | Windows/WSL |
| **Protégé** | Создание и редактирование онтологий (OWL, RDF), визуализация классов и отношений | Windows |
| **QGIS** | Работа с картографическими данными, геопривязка сущностей из графа | Windows |
| **Gephi / Cytoscape** | Анализ и визуализация больших графов, обнаружение сообществ (опционально) | Windows |

---

## 5. Архитектура и диалектический цикл

### 5.1. Процесс синтеза знаний

```
┌─────────────────────────────┐
│  ТЕЗИС (Новый корпус)       │
│  Текстовые документы        │
│         ↓                   │
│  LLM (Ollama)               │
│  Llama 3.3 70B / DeepSeek   │
│         ↓                   │
│  Неорганизованные триплеты  │
│  (хаос)                     │
└──────────┬──────────────────┘
           │
           │  СТОЛКНОВЕНИЕ
           ↓
     ┌─────────────┐
     │   СИНТЕЗ    │
     │  Процесс:   │
     │ 1. Маппинг  │
     │ 2. Конфликты│
     │ 3. Решения  │
     │ 4. Интеграция│
     └─────────────┘
           ↓
  ┌────────┴─────────┐
  │  Ламинарный рост │  Турбулентный рост
  │  (вписываются)   │  (требуют изменений)
  └────────┬─────────┘
           ↓
┌─────────────────────────────┐
│  РЕЗУЛЬТАТ СИНТЕЗА          │
│  Обогащённая онтология      │
│  (Neo4j / FalkorDB)         │
│  = новый АНТИТЕЗИС          │
└──────────┬──────────────────┘
           │
    ЭКСПЛУАТАЦИЯ
           │
           ↓
     ┌─────────┐
     │ Запросы │
     │ Ответы  │
     │ Аналитика│
     └─────────┘

┌─────────────────────────────┐
│  АНТИТЕЗИС (Онтология)      │
│  Существующая структура:    │
│  - Классы сущностей         │
│  - Типы отношений           │
│  - Иерархии                 │
│  - Ограничения              │
│  (порядок)                  │
└─────────────────────────────┘
```

### 5.2. Компоненты системы

- **Вход (Тезис)**: текстовые файлы/корпуса в папке `data/` проекта или в D:\projects
- **Обработка**: LLM (Ollama) извлекает триплеты
- **Синтез**: LightRAG/GraphRAG сопоставляет триплеты с онтологией
- **Хранение**: Neo4j или FalkorDB в Docker (графовая БД)
- **Выход**: обогащённая онтология + ответы на вопросы пользователя

### 5.3. Docker и графовые БД

- **Данные Docker:** при движке WSL 2 образы и тома хранятся в виртуальном диске WSL (файл `ext4.vhdx` на диске D:). Отдельно ничего переносить не нужно.
- **Проверка:** из терминала Cursor (WSL) команда `docker ps` должна выполняться без ошибок. Если демон недоступен — запустить Docker Desktop в Windows и включить WSL Integration для Ubuntu (Settings → Resources → WSL Integration).
- **Первый запуск графовой БД (задача 4.4):**

  **Neo4j** (визуализация, Cypher):  
  `docker run -d --name neo4j -p 7474:7474 -p 7687:7687 -e NEO4J_AUTH=neo4j/ВАШ_ПАРОЛЬ neo4j:latest`  
  Интерфейс: http://localhost:7474, Bolt: localhost:7687.

  **FalkorDB** (легче, Redis-протокол, LightRAG):  
  `docker run -d --name falkordb -p 6379:6379 falkordb/falkordb:latest`  
  Подключение: localhost:6379.

- **Ресурсы (по желанию):** Docker Desktop → Settings → Resources — ограничить Memory/CPUs, чтобы контейнеры не конкурировали с Ollama и индексацией.
- **WSL:** лимит памяти задаётся в `C:\Users\Admin\.wslconfig` (memory=32GB и др.). После изменений: PowerShell → `wsl --shutdown`, затем снова открыть Ubuntu/Cursor.

---

## 6. Организация данных и структура проекта

### 6.1. Разделение дисков (Samsung 990 Pro 2 ТБ)

```
├── C: (Windows 11 Pro, 300 ГБ, NTFS)
│   ├── Windows/                  # ОС
│   ├── Program Files/            # Приложения (Cursor, Docker Desktop, Ollama, Protégé, QGIS)
│   ├── Users/
│   │   └── Admin/
│   │       ├── AppData/Local/
│   │       │   └── Cursor/  → D:\AI\Cursor (символическая ссылка)
│   │       └── .cursor/
│   └── [Pagefile.sys]            # Файл подкачки (фиксированный, 16 ГБ)
│
└── D: (DATA, ~1.7 ТБ, NTFS)
    ├── AI/
    │   ├── AI_MODELS/            # Веса моделей Ollama (~200-400 ГБ)
    │   │   ├── llama3.2/
    │   │   ├── llama3.3-70b/
    │   │   └── deepseek-r1/
    │   │
    │   ├── WSL/                  # Виртуальный диск WSL2
    │   │   └── Ubuntu/
    │   │       └── ext4.vhdx     # ~50-100 ГБ (растёт)
    │   │
    │   └── Cursor/               # Локальные данные Cursor
    │
    ├── projects/                 # Проекты и код
    │   └── graph-rag-lab/        # Этот проект (монтируется в WSL)
    │
    ├── ontologies/               # OWL/RDF-схемы онтологий
    ├── graphs/                   # Экспорты графовых БД
    └── backups/                  # Резервные копии
```

### 6.2. Структура проекта graph-rag-lab

```
graph-rag-lab/
├── docs/                 # Документация проекта
│   ├── PROJECT.md        # Этот файл — проектная документация
│   ├── TASKS.md          # Задачи и ход исполнения
│   └── JOURNAL.md        # Журнал проекта (события, чаты)
├── src/                  # Исходный код (скрипты, пайплайны RAG)
├── data/                 # Входные текстовые корпуса
├── ontologies/           # Созданные онтологии (OWL, RDF)
├── configs/              # Конфигурации LightRAG/GraphRAG
├── 26-0201_chat.txt      # Исходный чат-источник решений
└── README.md
```

### 6.3. Настройки приложений

**Ollama** (переменная окружения):
```powershell
OLLAMA_MODELS=D:\AI\AI_MODELS
```

**Docker Desktop** (Settings → Resources → Advanced):
```yaml
data-root: D:\AI\WSL\Ubuntu\docker
```

**WSL (.wslconfig)** в `C:\Users\Admin\.wslconfig`:
```ini
[wsl2]
memory=32GB              # Треть от 64 ГБ (остальное для Windows и Ollama)
processors=8             # Все ядра Ryzen 7 8845HS
localhostForwarding=true
```

---

## 7. Работа с онтологиями: Ядро проекта

### 7.1. Роль онтологии в диалектическом процессе

Онтология — это не просто «схема данных», а **Антитезис** в диалектическом процессе познания. Она представляет собой накопленное структурированное знание, с которым сталкиваются новые неорганизованные данные.

**Зачем нужна онтология в GraphRAG?**

**Проблема без онтологии:**
- LLM извлекает сущности и связи хаотично
- Один объект может называться по-разному ("работает в", "сотрудник", "трудится")
- Граф превращается в "лапшу" из несвязанных узлов

**Решение через онтологию:**
- Заранее определены **типы сущностей** (классы: Person, Organization, Event)
- Заранее определены **типы связей** (предикаты: worksFor, participatedIn)
- LLM заполняет структуру, как форму, а не рисует с чистого листа

### 7.2. Создание онтологии

**Инструменты:**
- **Protégé** — графический редактор онтологий (OWL, RDF)
- **RDFLib** — программное создание онтологий на Python

**Процесс:**
1. Определить классы сущностей (например: Person, Organization, Event)
2. Определить свойства (worksFor, participatedIn, hasDate)
3. Задать ограничения (domain, range, иерархии)
4. Экспорт в OWL/RDF для использования в LightRAG/GraphRAG

### 7.3. Применение онтологии в LightRAG

**Способ 1: Prompt Engineering**
```python
extraction_prompt = """
Извлеки из текста только следующие типы сущностей:
- Person (имя человека)
- Organization (название организации)
- Event (событие с датой)

И только следующие связи:
- Person -> worksFor -> Organization
- Person -> participatedIn -> Event
- Event -> hasDate -> Date

Игнорируй любые другие сущности и связи.
"""
```

**Способ 2: Pydantic-схемы**
```python
from pydantic import BaseModel
from typing import Literal

class Entity(BaseModel):
    name: str
    type: Literal["Person", "Organization", "Event"]

class Relation(BaseModel):
    source: str
    predicate: Literal["worksFor", "participatedIn", "hasDate"]
    target: str
```

### 7.4. Применение онтологии в MS GraphRAG

```yaml
# settings.yaml
entity_extraction:
  entity_types:
    - Person
    - Organization
    - Event
  
  relation_types:
    - worksFor
    - participatedIn
    - hasDate
```

### 7.5. Выбор модели для работы с онтологией

Качество следования онтологии зависит от размера модели:

| Размер модели | Качество следования схеме | Рекомендация |
|---------------|---------------------------|--------------|
| 7B-14B | Среднее (может нарушать правила) | Для простых онтологий (<10 классов) |
| 30B-70B | Высокое (строго соблюдает структуру) | **Рекомендуется для проекта** (Q4/Q5) |

**Для данной системы (64 ГБ ОЗУ):** Llama 3.3 70B с квантованием Q4_K_M — оптимальный выбор для работы со сложными онтологиями.

---

## 8. Концепция "Двух Миров" и развитие проекта

### 8.1. Текущее состояние (Этап 1)
**Windows 11 + WSL2 (Ubuntu)** — единая система на Samsung 990 Pro

**Готово:**
- Концепция и философская основа (диалектический подход)
- Выбор железа и стека
- Настройка Windows 11 Pro (драйверы AMD, Wi‑Fi RZ616, NPU, время)
- WSL2 (Ubuntu) перенесена на диск D:
- Cursor с интеграцией WSL и Ollama
- Проект `graph-rag-lab` создан в WSL
- Docker Desktop (WSL 2) установлен и проверен

**В процессе:**
- Первый контейнер графовой БД (Neo4j/FalkorDB)
- Пайплайн LightRAG с привязкой к онтологии
- Разработка базовой онтологии в Protégé

### 8.2. Целевое состояние (Этап 2, планируется)
**Dual-boot: Windows 11 + Fedora 43** — разделение функций

#### Распределение систем

| Система | Диск | Функции |
|---------|------|---------|
| **Windows 11 Pro** | Samsung 990 Pro (C:, 300 ГБ) | **"Станция управления"**:<br>- Визуализация (Neo4j Browser, Protégé, QGIS)<br>- Разработка (Cursor)<br>- Чаты с Ollama<br>- Создание онтологий |
| **Fedora 43** | Второй SSD 1-2 ТБ | **"Лаборатория вычислений"**:<br>- Тяжёлая индексация (GraphRAG)<br>- Модели 70B+ с квантованием<br>- Docker-контейнеры (Neo4j, FalkorDB)<br>- Нативная производительность |
| **Общий раздел** | Samsung 990 Pro (D:, ~1.7 ТБ) | **Единое хранилище**:<br>- Модели Ollama (D:\AI_MODELS)<br>- Проекты (D:\projects)<br>- NTFS (читается обеими ОС) |

#### Преимущества разделения

1. **Производительность**: Fedora даёт +5-10% к скорости работы LLM
2. **Стабильность**: Долгие вычисления в Linux не блокируют Windows
3. **Гибкость**: Работа с онтологией в Windows, пока идёт индексация в Fedora
4. **Память**: Fedora может использовать все 64 ГБ без конкуренции
5. **Экономия**: Модели не дублируются (читаются с D: обеими системами)

### 8.3. Перспективы развития

#### Этап 3: Усиление железа (опционально)

**eGPU через OCuLink:**
- Порт OCuLink в GMKtec NucBox K8 Plus
- Рассматриваемые видеокарты: RTX 4070 Ti / 4080 (16 ГБ VRAM)
- Ускорение индексации в 3-5 раз
- Возможность работы с моделями 120B+
- В Fedora поддержка eGPU через OCuLink часто работает "из коробки"

| Параметр | Текущее (iGPU) | С eGPU (RTX 4070 Ti) |
|----------|----------------|----------------------|
| VRAM | 8 ГБ | 16 ГБ |
| Скорость индексации | ~10-20 с/страница | ~3-5 с/страница |
| Максимальная модель | 30B (Q4) | 70B+ (Q5/Q6) |
| Параллельные задачи | 1 LLM | 2-3 LLM одновременно |

#### Этап 4: Интеграция с картографией

- Автоматическая геопривязка сущностей из текста
- Пространственные запросы по графу (QGIS)
- Визуализация связей на картах
- Временная ось исторических событий

## 9. Источники решений

Решения по целям, стеку, железу и пошаговой настройке зафиксированы в чате с ИИ-ассистентом (январь-февраль 2026):

- **Файл чата**: `26-0201_chat.txt`
- **Связь с документацией**: в `docs/JOURNAL.md` события привязаны к фрагментам этого чата; в `docs/TASKS.md` задачи согласованы с описанными в чате шагами.

---

Детальный статус задач — в `docs/TASKS.md`, хронология событий — в `docs/JOURNAL.md`.
