# Предложения по дальнейшей работе (после плана 26-0219-2034)

**Контекст:** На предстоящих этапах ожидается много проверок и доработок через браузер на https://ontoline.ru/ferag/. Чтобы оперативно вносить исправления и выкатывать их на cr-ubu, нужен удобный процесс развёртывания.

---

## 1. Рекомендация: сначала «урезанный» вариант, не полноценный CI/CD

**Полноценный CI/CD** (GitHub Actions: линтеры, тесты на каждый push, сборка, деплой в staging/prod, секреты в репозитории) сейчас избыточен:

- Нет пока автотестов, которые должны блокировать деплой.
- Backend вы собираете по **варианту B** на nb-win и везёте образ на cr-ubu; в GitHub Actions нет доступа к nb-win и к вашей сети (WireGuard), собирать backend в раннере можно, но тогда два разных пути сборки (локальный и CI).
- Настройка секретов (SSH-ключ, .env), self-hosted runner или ограничения публичного раннера усложняют жизнь без немедленной выгоды.

**Рациональный минимум** — сделать развёртывание **однообразным и быстрым** без внедрения CI/CD:

- Два скрипта (или одна команда «всё»): **деплой frontend** и **деплой backend**.
- Запуск с nb-win вручную после правок (один раз настроил — дальше `./scripts/deploy-frontend.sh` и/или `./scripts/deploy-backend.sh`).
- Скрипты опираются на уже описанную в [deploy/DEPLOYMENT_SUMMARY.md](../../deploy/DEPLOYMENT_SUMMARY.md) процедуру и на SSH cursor-agent.

Так вы получаете **оперативное внесение исправлений с развёртыванием** за 1–2 команды, без GitHub, без секретов в облаке.

---

## 2. Что сделать сейчас

| Действие | Назначение |
|----------|------------|
| **Добавить скрипты деплоя** | `scripts/deploy-frontend.sh` и `scripts/deploy-backend.sh` (или оба в `deploy/`), вызывающие текущие команды из DEPLOYMENT_SUMMARY: сборка → scp → на cr-ubu load/restart или копирование в `/var/www/ferag`. |
| **Дописать DEPLOYMENT_SUMMARY** | Краткий подраздел «Быстрый деплой после правок» со ссылкой на скрипты и условиями (ключ, known_hosts, .env на cr-ubu уже настроены). |
| **При желании — один GitHub Action только для frontend** | По push в `main`: `npm run build` в раннере → scp `dist/` на cr-ubu в `/var/www/ferag`. Backend по-прежнему деплоится вручную скриптом. Это даёт «запушил — через пару минут фронт обновился» без ручного запуска. |

Имеет смысл **сначала ввести скрипты** и пару раз пройти цикл «правка → скрипт → проверка в браузере». Если окажется, что чаще всего правится фронт и хочется автоматизировать именно его выкат по push — тогда добавить один простой workflow для frontend.

---

## 3. Когда имеет смысл полноценный CI/CD

Отложить до момента, когда:

- появятся **автотесты** (unit, e2e или хотя бы smoke), которые должны проходить перед выкатом;
- понадобится **разделение окружений** (staging / prod) с разными выкатами;
- в команде будет не один человек и нужна **единая кнопка «собрать и выкатить»** с историей в GitHub.

До этого скрипты + опционально один job «frontend deploy» закрывают задачу оперативного развёртывания.

---

## 4. Более приоритетные задачи (если выбирать)

Если объём браузерного тестирования пока небольшой и хочется двигать функциональность:

- **AGE / pgvector, проекции** (блок 9, 4.x в TASKS.md) — следующая крупная тема по плану.
- **История диалога** (сохранение вопросов/ответов в БД) — улучшает UX и не требует менять деплой.

Тогда вопрос «оперативное внесение исправлений + развёртывание» можно решить **минимально**: только скрипты деплоя в репозитории и абзац в DEPLOYMENT_SUMMARY, без GitHub Actions. Как только начнётся активная итерация по фидбеку из браузера — те же скрипты уже будут под рукой.

---

## 5. Итог

| Вариант | Что делать | Когда |
|---------|------------|--------|
| **Минимум (рекомендуется сейчас)** | Скрипты `deploy-frontend.sh` и `deploy-backend.sh`, обновить DEPLOYMENT_SUMMARY | Сразу; один раз настроил — все правки выкатываются одной-двумя командами. |
| **Урезанный «CI»** | Один GitHub Action: build frontend → deploy на cr-ubu по SSH | По желанию, если часто правится фронт и хочется деплой по push. |
| **Полноценный CI/CD** | Тесты, линтеры, несколько окружений, деплой по правилам | После появления автотестов и явной потребности в процессе. |

Приоритет: **внедрить скрипты быстрого деплоя** — они не конфликтуют с будущим CI/CD и сразу сокращают время между правкой и проверкой в браузере.

---

## 6. Может ли AI-агент выполнять быстрый деплой сам?

**Backend — да.** Скрипт `deploy-backend.sh` использует только ключ `cursor_agent_key` и пользователя cursor-agent (всё есть в репозитории). Агенту при запуске команды нужно выдать права **network** и **all** (для Docker build/save). После этого деплой backend агент выполняет без вашей помощи.

**Frontend — да, после одноразовой настройки на cr-ubu.** Текущий вариант скрипта рассчитан на user1 и `sudo` для копирования в `/var/www/ferag`, к чему у агента доступа нет. Поэтому добавлен режим **cursor-agent**: скрипт вызывается как `DEPLOY_USE_CURSOR_AGENT=1 ./scripts/deploy-frontend.sh` и пишет в каталог `~/ferag-www` на cr-ubu по ключу проекта. Чтобы это совпадало с тем, что отдаёт Nginx, на сервере один раз делают: `/var/www/ferag` делают симлинком на `~/cursor-agent/ferag-www` (инструкция в [deploy/DEPLOYMENT_SUMMARY.md](../../deploy/DEPLOYMENT_SUMMARY.md), раздел «Деплой силами AI-агента»). После этой настройки агент может деплоить frontend с правом **network**.

**Что сделать, чтобы агент делал оба деплоя сам:** (1) Один раз на cr-ubu выполнить команды из DEPLOYMENT_SUMMARY (mkdir, chown, ln -s для ferag-www). (2) При запросе деплоя агент запускает `./scripts/deploy-backend.sh` (с правами network + all) и/или `DEPLOY_USE_CURSOR_AGENT=1 ./scripts/deploy-frontend.sh` (с правами network). Правило [.cursor/rules/deploy-cr-ubu-ssh.mdc](../../.cursor/rules/deploy-cr-ubu-ssh.mdc) обновлено: в нём описано, как агенту выполнять быстрый деплой.
