# Резюме работы по плану 26-0219-2034

**План:** [26-0219-2034_plan.md](26-0219-2034_plan.md) (Чат 3 — Frontend (Vue) + деплой)  
**Период:** 2026-02-19 — 2026-02-20  
**Итог:** План выполнен полностью. Реализованы API участников RAG, миграция `source_content`, кросс-машинный upload через БД, Dockerfile backend, Vue 3 SPA, деплой backend и frontend на cr-ubu, Nginx; финальная проверка в браузере пройдена — полный сценарий register → login → create RAG → upload → approve → chat работает на https://ontoline.ru/ferag/.

---

## Выполнено

### 1. API управления участниками RAG

В `code/backend/app/routers/rags.py` добавлены:

| Эндпоинт | Назначение |
|----------|------------|
| `POST /rags/{rag_id}/members` | Добавить участника по email (роль viewer/editor); только owner |
| `GET /rags/{rag_id}/members` | Список участников (owner + members); доступ владельцу и участникам |
| `DELETE /rags/{rag_id}/members/{user_id}` | Удалить участника; только owner, нельзя удалить себя |

Модели: `MemberAddBody`, `MemberResponse`, `MemberListItem`.

### 2. Alembic: миграция `source_content`

- В модель `UploadCycle` добавлено поле `source_content: Mapped[Optional[str]]` (Text, nullable).
- Миграция `1316c47e2e74_add_upload_cycle_source_content.py` создана и применена (`alembic upgrade head`).

### 3. Кросс-машинный upload (backend + worker)

- **Backend:** в `POST /rags/{id}/upload` после чтения файла записывается `cycle.source_content = content.decode("utf-8")`, сохраняется в БД.
- **Worker:** в `graphrag_task._prepare_work_dir` при отсутствии локального файла вызывается `get_cycle_source_content(cycle_id)` (в `base.py` — raw SQL к `upload_cycles.source_content`), содержимое записывается в `work_dir/input/source.txt`. Добавлены проверки на пустой контент и непустой итоговый файл.

### 4. Backend Dockerfile и отправка задач без worker-пакета

- Создан `code/backend/Dockerfile` (python:3.11-slim, requirements, CMD uvicorn).
- В `app/config.py` добавлены `celery_broker_url`, `celery_result_backend`.
- Создан `app/celery_sender.py`: `send_update_chain(rag_id, cycle_id, task_id, input_file)` — цепочка задач через `app.signature("worker.tasks....", ...)` по имени, без импорта worker-пакета.
- В `rags.py` вызов заменён с `start_update_chain(...)` на `send_update_chain(...)`.
- Добавлен `code/backend/.dockerignore`.

### 5. Docker Compose и Fuseki для доступа с cr-ubu

- `deploy/cr-ubu/docker-compose.yml`: для сервиса `ferag` добавлены `CELERY_BROKER_URL`, `CELERY_RESULT_BACKEND`, ссылка на образ `ferag-backend:latest` для варианта B.
- `deploy/nb-win/docker-compose.yml`: для Fuseki порты приведены к `0.0.0.0:43030:3030` (доступ по WireGuard с cr-ubu).

### 6. Frontend Vue 3 + Vite

Создан каталог `code/frontend/`:

| Область | Файлы / назначение |
|---------|--------------------|
| API | `client.ts` (axios, baseURL `/ferag/api/`, JWT), `auth.ts`, `rags.ts`, `upload.ts`, `tasks.ts`, `approve.ts`, `chat.ts`, `members.ts` |
| Stores | `auth.ts` (token, user, login/logout), `rags.ts` |
| Router | Маршруты с guard `requireAuth` |
| Views | `LoginView`, `RagsView`, `RagDetailView` (вкладки), `UploadView` (загрузка + TaskProgress + approve), `ChatView`, `MembersView` |
| Components | `NavBar`, `TaskProgress` (WebSocket по taskId), `MessageBubble` |

Конфиг: `base: '/ferag/'`, proxy для `/ferag/api` и `/ferag/ws` на localhost:47821. Сборка: `npm run build` → `dist/`.

### 7. Деплой frontend на cr-ubu

- Каталог `/var/www/ferag` создан на cr-ubu, владелец www-data.
- Артефакты из `code/frontend/dist/` доставлены (rsync/scp), разложены в `/var/www/ferag/`.

### 8. Деплой backend на cr-ubu (вариант B)

- Образ собирается на nb-win: `docker build -t ferag-backend:latest -f code/backend/Dockerfile code/backend/`.
- Экспорт: `docker save ... | gzip > /tmp/ferag-backend.tar.gz`, загрузка на cr-ubu через scp (cursor-agent).
- На cr-ubu: `docker load`, контейнер `ferag` запущен через `docker run` в `~/ferag-deploy/` с переменными из `.env` (DATABASE_URL, FUSEKI_*, JWT_SECRET, REDIS_*, CELERY_*, ALLOWED_ORIGINS, LLM_API_URL, LLM_MODEL).
- Контейнеры: `ferag`, `ferag-redis` (bridge, порт 127.0.0.1:47821).

### 9. Nginx на cr-ubu

- Конфиг `deploy/cr-ubu/nginx-location-ferag.conf` скопирован в `/etc/nginx/snippets/ferag.conf`.
- В `sites-available/ontoline.ru` добавлено `include /etc/nginx/snippets/ferag.conf;`.
- `nginx -t && systemctl reload nginx` — успешно. https://ontoline.ru/ferag/ отдаёт Vue SPA.

### 10. Порядок первого сквозного запуска

Зафиксирован и выполнен: nb-win (postgres, fuseki, worker) → Windows LM Studio (:1234) → cr-ubu (redis, ferag) → nginx reload → браузер.

### 11. Финальная проверка (браузер)

Сценарий выполнен по шагам:

1. `/ferag/` → redirect на login.  
2. Регистрация и вход.  
3. Создание RAG «Тестовый».  
4. Загрузка `scripts/test_source.txt` → прогресс pipeline по WebSocket.  
5. Ожидание `status: done`, активация кнопки «Подтвердить».  
6. Approve цикла.  
7. Вкладка «Диалог», вопрос «Кто такой Alice Smith?».  
8. Ответ LLM: «Alice Smith — это инженер-программист, работающий в корпорации ACME.»

---

## Зафиксированные проблемы и решения

| Проблема | Причина | Решение |
|----------|---------|---------|
| 500 при регистрации | `DATABASE_URL` на cr-ubu указывал на `localhost:45432` | В `.env` на cr-ubu хост заменён на `10.7.0.3:45432`, контейнер ferag перезапущен |
| 500 при создании RAG | `FUSEKI_URL` на cr-ubu — `localhost:43030` | В `.env` хост заменён на `10.7.0.3:43030` |
| graphrag: No .txt matches | Worker со старым кодом / пустой source.txt | Перезапуск ferag-worker; в `_prepare_work_dir` добавлены проверки source_content и размера файла |
| 401 после перезахода, нет кнопки «Подтвердить» | UploadView не восстанавливал состояние при перезагрузке | Endpoint `GET /rags/{id}/upload-status` + в Vue `onMounted` с вызовом `getUploadStatus`, восстановление cycleId/taskId/uploadDone |
| 500 при approve (405 от Fuseki) | Датасет не существовал; Fuseki слушал только 127.0.0.1 | Создание датасетов вручную; порт Fuseki `0.0.0.0:43030:3030`; в `fuseki_client.export_dataset_to_ttl` обработка 405 как пустой датасет; в `create_rag` — try/except вокруг `create_dataset` |
| 503 в чате (No module named 'rag_context') | Модули `rag_context`, `rag_llm` из graphrag-test не входили в образ backend | Копия `rag_context.py` и `rag_llm.py` в `code/backend/`, пересборка образа; в `.env` на cr-ubu добавлены `LLM_API_URL=http://10.7.0.3:1234/v1`, `LLM_MODEL=llama-3.3-70b-instruct`; контейнер пересоздан с новым образом |

---

## Артефакты

| Артефакт | Назначение |
|----------|------------|
| `code/backend/rag_context.py`, `rag_llm.py` | Копии из graphrag-test для RAG-чата в Docker-образе |
| `code/backend/app/celery_sender.py` | Отправка цепочки задач по имени без импорта worker |
| `code/backend/app/routers/rags.py` | Members API, upload-status, create_rag try/except, upload → source_content |
| `code/backend/alembic/versions/1316c47e2e74_*.py` | Миграция source_content |
| `code/worker/tasks/graphrag_task.py` | _prepare_work_dir с get_cycle_source_content, проверки файла |
| `code/worker/fuseki_client.py` | Обработка 405 в export_dataset_to_ttl |
| `code/frontend/` | Vue 3 + Vite SPA (api, views, components, WebSocket TaskProgress) |
| `deploy/nb-win/docker-compose.yml` | Fuseki 0.0.0.0:43030 |
| `deploy/DEPLOYMENT_SUMMARY.md` | Описание деплоя, DATABASE_URL/FUSEKI_URL на cr-ubu |
| `docs/chats/26-0219-2034_plan.md` | План с отметками выполнения и списком проблем/решений |

---

## Инфраструктурные решения

- **source_content в PostgreSQL:** при кросс-машинном деплое (backend на cr-ubu, worker на nb-win) общий work_dir недоступен; содержимое загруженного файла сохраняется в `upload_cycles.source_content`, worker читает его из БД и пишет в локальный work_dir.
- **Backend без worker-пакета на cr-ubu:** задачи в Celery отправляются через `send_task` по строковому имени задач; образ backend не содержит `code/worker/`.
- **RAG-чат в образе backend:** модули `rag_context` и `rag_llm` скопированы в `code/backend/`, чтобы эндпоинт `POST /rags/{id}/chat` работал в контейнере на cr-ubu (Fuseki и LLM доступны по 10.7.0.3).
- **Fuseki на всех интерфейсах:** биндинг `0.0.0.0:43030` обеспечивает доступ с cr-ubu по WireGuard (10.7.0.3).

---

## Критерии успеха (выполнены)

- ✅ https://ontoline.ru/ferag/ открывается, отображается форма входа.
- ✅ Сценарий register → login → create RAG → upload → WebSocket-прогресс → approve → chat выполняется в браузере.
- ✅ `GET /rags/{id}/members` возвращает список; `POST` добавляет участника по email.
- ✅ Backend в Docker на cr-ubu (`ferag`), Nginx перезагружен без ошибок.

---

## Вне объёма плана (на будущее)

- AGE/pgvector-проекции — Чат 4 или отдельный план.
- CI/CD (GitHub Actions) — задача 9.10.
- История диалога (вопросы/ответы в БД), аватары, мониторинг — будущие планы.

---

## Состояние сервисов на момент завершения

| Сервис | Статус | Адрес |
|--------|--------|--------|
| PostgreSQL (nb-win) | ✅ | `10.7.0.3:45432` |
| Fuseki (nb-win) | ✅ | `10.7.0.3:43030` (0.0.0.0) |
| Redis (cr-ubu) | ✅ | 172.17.0.2:47379 (внутри bridge) |
| Worker (nb-win, Docker) | ✅ | — |
| Backend ferag (cr-ubu, Docker) | ✅ | 127.0.0.1:47821 → Nginx |
| Frontend (cr-ubu) | ✅ | /var/www/ferag → https://ontoline.ru/ferag/ |
| Nginx (cr-ubu) | ✅ | include ferag.conf |
| LM Studio (Windows) | ⚡ по необходимости | localhost:1234 / 10.7.0.3:1234 |
| WireGuard (nb-win ↔ cr-ubu) | ✅ | 10.7.0.1 ↔ 10.7.0.3 |

---

## Следующий шаг

**Чат 4 или отдельный план:** AGE/pgvector-проекции, индексы; при необходимости — CI/CD, история диалога. Текущий план закрыт: [26-0219-2034_plan.md](26-0219-2034_plan.md).
