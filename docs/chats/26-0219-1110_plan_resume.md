# Резюме работы по плану 26-0219-1110

**План:** [26-0219-1110_plan.md](26-0219-1110_plan.md) (Чат 2 — Worker + полный цикл обновления RAG)  
**Период:** 2026-02-19  
**Итог:** План выполнен полностью. Реализован `code/worker/` (Celery); backend расширен четырьмя эндпоинтами; адаптированы скрипты `graphrag-test/`; финальная проверка пройдена дважды — полный pipeline от загрузки файла до LLM-ответа работает.

---

## Выполнено

### 1. Redis на cr-ubu

- Контейнер `ferag-redis` поднят через `docker run` (образ `redis:7-alpine`, порт `10.7.0.1:47379`, том `ferag-redis-data`, `--restart unless-stopped`).
- Использован `docker run` вместо `docker-compose up`, так как на cr-ubu установлен `docker-compose` v1.29.2 (без плагина Compose v2) и проект на cr-ubu не развёрнут.
- Проверка: `docker exec ferag-redis redis-cli -p 47379 ping` → `PONG`; `redis-cli -h 10.7.0.1 -p 47379 ping` с nb-win через WireGuard → `PONG`.

### 2. Структура `code/worker/`

Создан полноценный Celery-пакет:

| Файл | Назначение |
|------|------------|
| `code/worker/__init__.py` | Пакет Python |
| `code/worker/config.py` | `Settings` (BaseSettings): broker, backend, db, fuseki, llm, work_dir |
| `code/worker/celery_app.py` | `Celery("ferag_worker")` + подключение четырёх модулей задач |
| `code/worker/fuseki_client.py` | Обёртка Fuseki: create/delete dataset, export TTL, load TTL, SPARQL helpers |
| `code/worker/tasks/__init__.py` | `start_update_chain(rag_id, cycle_id, task_id, input_file)` |
| `code/worker/tasks/base.py` | `get_db_session`, `publish_status`, `update_task`, `on_chain_failure` |
| `code/worker/tasks/graphrag_task.py` | `run_graphrag` — подготовка work_dir, запуск `graphrag index` |
| `code/worker/tasks/schema_task.py` | `run_schema_induction` |
| `code/worker/tasks/merge_task.py` | `do_merge` — `merge_ontologies` + `merge_triples` |
| `code/worker/tasks/staging_task.py` | `load_to_staging` — загрузка TTL в Fuseki, cycle status → review |
| `code/worker/requirements.txt` | celery[redis], sqlalchemy, graphrag, llama-index-*, rdflib, … |
| `code/worker/Dockerfile` | `python:3.11-slim`; PYTHONPATH `/app:/app/graphrag-test` |

### 3. Адаптация `graphrag-test/` как библиотеки

- В скрипты добавлены вызываемые функции без изменения CLI:
  - `test_graphrag_to_rdf.py` → `graphrag_to_rdf(root_dir, output_path)`
  - `test_schema_induction.py` → `run_schema_induction(root_dir, output_path, llm_base_url, model)`
  - `merge_ontologies.py` → `merge_ontologies(path1, path2, out_path, report_path=None)`
  - `merge_triples.py` → `merge_triples(path1, path2, out_path, report_path=None)`
- Создан `graphrag-test/graphrag_lib/__init__.py`: реэкспорт четырёх обёрток; добавление `graphrag-test/` в `sys.path`.

### 4. Backend: новые эндпоинты

| Эндпоинт | Назначение |
|----------|------------|
| `POST /rags/{id}/upload` | Сохранить файл в work_dir, создать UploadCycle + Task, запустить chain |
| `GET /ws/tasks/{id}?token=…` | WebSocket: подписка на Redis `task:{id}`, стрим статусов |
| `POST /rags/{id}/cycles/{id}/approve` | Мерж staging → prod в Fuseki; удаление промежуточных датасетов |
| `POST /rags/{id}/chat` | SPARQL-контекст по вопросу + LLM-ответ |

В `app/config.py` добавлены: `work_dir`, `llm_api_url`, `llm_model`, `redis_url`.  
В `requirements.txt` добавлены: `redis[asyncio]`, `requests`, `openai`.

### 5. Celery цепочка задач

```
run_graphrag.s(…)
    → run_schema_induction.si(…)
    → do_merge.si(…)
    → load_to_staging.si(…)
    (link_error=on_chain_failure.s())
```

Шаги 2–4 используют `.si()` для независимости от результата предыдущей задачи. `on_chain_failure` публикует ошибку в Redis и устанавливает `Task.status = 'failed'`.

### 6. Alembic

Расхождений между `models.py` и существующей миграцией `8355f4b3f5a9_initial.py` не обнаружено. Дополнительная миграция не потребовалась.

### 7. Финальная проверка

Сценарий `scripts/run_final_check.py` пройден дважды (RAG id=22 и id=23):

| Шаг | Результат |
|-----|-----------|
| `GET /health` | 200 |
| `POST /auth/register` + login | токен получен |
| `POST /rags` | RAG создан, датасет в Fuseki |
| `POST /rags/{id}/upload` | cycle_id + task_id возвращены |
| polling `GET /tasks/{id}` | status=done (~12 мин) |
| `POST /rags/{id}/cycles/{id}/approve` | cycle_count=1 |
| `POST /rags/{id}/chat` | LLM ответил про Alice Smith и ACME Corporation |

---

## Исправления в процессе

| Файл | Проблема | Исправление |
|------|----------|-------------|
| `deploy/nb-win/docker-compose.yml` | LM Studio порт `41234` (неверный для Windows-хоста) | исправлен на `1234` |
| `deploy/nb-win/docker-compose.yml` | worker не видел файл, сохранённый backend в `/tmp/ferag` | добавлен volume `/tmp/ferag:/tmp/ferag` |
| `code/worker/tasks/base.py` | `on_chain_failure(request, excinfo)` — Celery передаёт 3 аргумента | исправлена сигнатура на `(request, exc, traceback)` |
| `code/worker/tasks/graphrag_task.py` | `shutil.copy2` падал при src==dst | добавлена проверка `src != dst` перед копированием |
| `code/worker/tasks/graphrag_task.py` | `_write_settings_yaml` писал в `models.default_chat_model` (старая схема) | поддержка схемы graphrag 3.x (`completion_models`) |
| `graphrag-test/settings.yaml` | несовместим с graphrag 3.0.2 | переписан: `completion_models`, `embedding_models`, `cache.type: none`, `embed_text.names: []`, `max_tokens: 4096`, `max_gleanings: 0` |
| `graphrag-test/prompts/*.txt` | шаблонные переменные `{tuple_delimiter}` — graphrag 3.0.2 использует жёсткие разделители | обновлены под 3.0.2: `<\|>`, `##`, `<\|COMPLETE\|>` |
| `scripts/run_final_check.py` | таймаут 30 мин — 70B модель не успевала | таймаут увеличен до 2 часов |
| `scripts/run_final_check.py` | тест на полном тексте занимал >1 часа | добавлена поддержка `FERAG_SOURCE_FILE` (короткий `scripts/test_source.txt`) |

---

## Артефакты

| Артефакт | Назначение |
|----------|------------|
| `code/worker/` | Весь пакет Celery-worker (создан с нуля) |
| `graphrag-test/graphrag_lib/__init__.py` | Python-обёртки для вызова pipeline из Celery |
| `graphrag-test/settings.yaml` | Конфиг GraphRAG 3.0.2 |
| `graphrag-test/prompts/*.txt` | Промпты с жёсткими разделителями 3.0.2 |
| `code/backend/app/routers/rags.py` | Добавлены upload, approve, chat |
| `code/backend/app/main.py` | Добавлен WebSocket `/ws/tasks/{id}` |
| `code/backend/app/config.py` | Добавлены work_dir, llm_api_url, llm_model, redis_url |
| `code/backend/app/fuseki_admin.py` | Добавлены sparql_update, get/put/post_dataset_ttl |
| `code/backend/app/deps.py` | Добавлен `get_current_user_ws` для WebSocket |
| `deploy/nb-win/docker-compose.yml` | Исправлен порт LM Studio; добавлен volume /tmp/ferag |
| `scripts/run_final_check.py` | Скрипт автоматической проверки |
| `scripts/test_source.txt` | Короткий тестовый текст (Alice Smith + ACME Corporation) |

---

## Инфраструктурные решения

- **Общий work_dir через volume:** при локальном запуске (backend в venv, worker в Docker) volume `/tmp/ferag:/tmp/ferag` в worker позволяет читать файлы, сохранённые backend на хосте WSL2.
- **GraphRAG 3.0.2 (Monica fork):** версия в Docker-образе отличается от оригинала Microsoft; конфиг и промпты адаптированы под неё (другая схема YAML, жёсткие разделители в промптах, отсутствие типа кэша `file`).
- **`--skip-validation` для `graphrag index`:** пропускает начальные вызовы LLM для валидации модели, ускоряя запуск pipeline.
- **Тест на коротком тексте:** `scripts/test_source.txt` (2 предложения) вместо полного корпуса снижает время LLM-инференса с >1 часа до ~12 минут при проверке pipeline.

---

## Критерии успеха (выполнены)

- ✅ Redis на cr-ubu отвечает на `ping` через WireGuard; `docker compose up -d worker` (nb-win) запускается без ошибок.
- ✅ `POST /rags/{id}/upload` возвращает `{cycle_id, task_id}`.
- ✅ WebSocket `/ws/tasks/{id}` стримит статусы всех шагов.
- ✅ После approve: `GET /rags/{id}` → `cycle_count == 1`.
- ✅ После approve: датасет `ferag-{id:05d}` содержит триплеты в Fuseki.
- ✅ `POST /rags/{id}/chat` → ответ LLM, не пустой.

---

## Не входило в план / перенесено

- `code/backend/Dockerfile` → **Чат 3**.
- Vue 3 frontend (`code/frontend/`) → **Чат 3**.
- Docker-деплой на cr-ubu (backend-контейнер) → **Чат 3**.
- Nginx-конфигурация на cr-ubu → **Чат 3**.
- Управление участниками RAG (`POST /rags/{id}/members`) → **Чат 3**.

---

## Состояние сервисов на момент завершения

| Сервис | Статус | Адрес |
|--------|--------|-------|
| PostgreSQL (`ferag-postgres`) | ✅ запущен | `localhost:45432` / `10.7.0.3:45432` |
| Fuseki (`ferag-fuseki`) | ✅ запущен | `localhost:43030` |
| Redis (`ferag-redis`, cr-ubu) | ✅ запущен | `10.7.0.1:47379` |
| Worker (`ferag-worker`, Docker, nb-win) | ✅ запущен | — |
| Backend (uvicorn, venv, nb-win) | ⚡ запускается вручную для разработки | `localhost:47821` |
| WireGuard (nb-win ↔ cr-ubu) | ✅ активен | `10.7.0.1 ↔ 10.7.0.3` |
| LM Studio (Windows) | ⚡ запускается по необходимости | `localhost:1234` |

---

## Следующий шаг

**Чат 3:** [26-0219-2034_plan.md](26-0219-2034_plan.md) — Frontend (Vue 3) + Backend Dockerfile + деплой на cr-ubu.
